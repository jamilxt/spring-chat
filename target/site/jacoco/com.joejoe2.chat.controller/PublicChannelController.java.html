<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PublicChannelController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">chat</a> &gt; <a href="index.source.html" class="el_package">com.joejoe2.chat.controller</a> &gt; <span class="el_source">PublicChannelController.java</span></div><h1>PublicChannelController.java</h1><pre class="source lang-java linenums">package com.joejoe2.chat.controller;

import com.joejoe2.chat.controller.constraint.auth.AuthenticatedApi;
import com.joejoe2.chat.data.ErrorMessageResponse;
import com.joejoe2.chat.data.PageList;
import com.joejoe2.chat.data.PageRequest;
import com.joejoe2.chat.data.SliceList;
import com.joejoe2.chat.data.channel.PageOfChannel;
import com.joejoe2.chat.data.channel.profile.PublicChannelProfile;
import com.joejoe2.chat.data.channel.request.CreatePublicChannelRequest;
import com.joejoe2.chat.data.channel.request.GetChannelProfileRequest;
import com.joejoe2.chat.data.channel.request.SubscribePublicChannelRequest;
import com.joejoe2.chat.data.message.PublicMessageDto;
import com.joejoe2.chat.data.message.SliceOfMessage;
import com.joejoe2.chat.data.message.request.GetAllPublicMessageRequest;
import com.joejoe2.chat.data.message.request.GetPublicMessageSinceRequest;
import com.joejoe2.chat.data.message.request.PublishPublicMessageRequest;
import com.joejoe2.chat.exception.AlreadyExist;
import com.joejoe2.chat.exception.ChannelDoesNotExist;
import com.joejoe2.chat.exception.UserDoesNotExist;
import com.joejoe2.chat.service.channel.PublicChannelService;
import com.joejoe2.chat.service.message.PublicMessageService;
import com.joejoe2.chat.utils.AuthUtil;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.media.ArraySchema;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import org.springdoc.api.annotations.ParameterObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import javax.validation.Valid;

@Controller
@RequestMapping(path = &quot;/api/channel/public&quot;)
<span class="fc" id="L44">public class PublicChannelController {</span>
    @Autowired
    PublicChannelService channelService;
    @Autowired
    PublicMessageService messageService;

    @Operation(summary = &quot;publish message to public channel&quot;)
    @AuthenticatedApi
    @SecurityRequirement(name = &quot;jwt&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;target channel is not exist&quot;,
                    content = @Content(mediaType = &quot;application/json&quot;,
                            schema = @Schema(implementation = ErrorMessageResponse.class))),
            @ApiResponse(
                    responseCode = &quot;200&quot;, description = &quot;publish message to target channel&quot;,
                    content = @Content),
    })
    @RequestMapping(path = &quot;/publishMessage&quot;, method = RequestMethod.POST)
    public ResponseEntity&lt;Object&gt; publishMessage(@Valid @RequestBody PublishPublicMessageRequest request) throws UserDoesNotExist {
        try {
<span class="nc" id="L64">            PublicMessageDto message = messageService.createMessage(AuthUtil.currentUserDetail().getId(), request.getChannelId(), request.getMessage());</span>
<span class="nc" id="L65">            messageService.deliverMessage(message);</span>
<span class="nc" id="L66">        } catch (ChannelDoesNotExist e) {</span>
<span class="nc" id="L67">            return new ResponseEntity&lt;&gt;(new ErrorMessageResponse(e.getMessage()), HttpStatus.NOT_FOUND);</span>
<span class="nc" id="L68">        }</span>
<span class="nc" id="L69">        return ResponseEntity.ok().build();</span>
    }

    @Operation(summary = &quot;get all messages in public channel&quot;)
    @AuthenticatedApi
    @SecurityRequirement(name = &quot;jwt&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;target channel is not exist&quot;,
                    content = @Content(mediaType = &quot;application/json&quot;,
                            schema = @Schema(implementation = ErrorMessageResponse.class))),
            @ApiResponse(
                    responseCode = &quot;200&quot;, description = &quot;messages in target channel&quot;,
                    content = @Content(mediaType = &quot;application/json&quot;,
                            schema = @Schema(implementation = SliceOfMessage.class))),
    })
    @RequestMapping(path = &quot;/getAllMessages&quot;, method = RequestMethod.GET)
    public ResponseEntity&lt;Object&gt; getMessages(@ParameterObject @Valid GetAllPublicMessageRequest request) {
        try {
<span class="nc" id="L87">            SliceList&lt;PublicMessageDto&gt; sliceList = messageService.getAllMessages(request.getChannelId(), request.getPageRequest());</span>
<span class="nc" id="L88">            return ResponseEntity.ok(new SliceOfMessage&lt;&gt;(sliceList));</span>
<span class="nc" id="L89">        } catch (ChannelDoesNotExist e) {</span>
<span class="nc" id="L90">            return new ResponseEntity&lt;&gt;(new ErrorMessageResponse(e.getMessage()), HttpStatus.NOT_FOUND);</span>
        }
    }

    @Operation(summary = &quot;get all messages in public channel since&quot;)
    @AuthenticatedApi
    @SecurityRequirement(name = &quot;jwt&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;target channel is not exist&quot;,
                    content = @Content(mediaType = &quot;application/json&quot;,
                            schema = @Schema(implementation = ErrorMessageResponse.class))),
            @ApiResponse(
                    responseCode = &quot;200&quot;, description = &quot;messages in target channel&quot;,
                    content = @Content(mediaType = &quot;application/json&quot;,
                            schema = @Schema(implementation = SliceOfMessage.class))),
    })
    @RequestMapping(path = &quot;/getMessagesSince&quot;, method = RequestMethod.GET)
    public ResponseEntity&lt;Object&gt; getMessagesSince(@ParameterObject @Valid GetPublicMessageSinceRequest request) {
        try {
<span class="nc" id="L109">            SliceList&lt;PublicMessageDto&gt; sliceList = messageService.getAllMessages(request.getChannelId(), request.getSince(), request.getPageRequest());</span>
<span class="nc" id="L110">            return ResponseEntity.ok(new SliceOfMessage&lt;&gt;(sliceList));</span>
<span class="nc" id="L111">        } catch (ChannelDoesNotExist e) {</span>
<span class="nc" id="L112">            return new ResponseEntity&lt;&gt;(new ErrorMessageResponse(e.getMessage()), HttpStatus.NOT_FOUND);</span>
        }
    }

    @Operation(summary = &quot;create public channel&quot;)
    @AuthenticatedApi
    @SecurityRequirement(name = &quot;jwt&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;403&quot;, description = &quot;target channel is already exist&quot;,
                    content = @Content(mediaType = &quot;application/json&quot;,
                            schema = @Schema(implementation = ErrorMessageResponse.class))),
            @ApiResponse(
                    responseCode = &quot;200&quot;, description = &quot;create public channel&quot;,
                    content = @Content),
    })
    @RequestMapping(path = &quot;/create&quot;, method = RequestMethod.POST)
    public ResponseEntity&lt;Object&gt; create(@Valid @RequestBody CreatePublicChannelRequest request) {
        try {
<span class="nc" id="L130">            channelService.createChannel(request.getChannelName());</span>
<span class="nc" id="L131">        } catch (AlreadyExist e) {</span>
<span class="nc" id="L132">            return new ResponseEntity&lt;&gt;(new ErrorMessageResponse(e.getMessage()), HttpStatus.FORBIDDEN);</span>
<span class="nc" id="L133">        }</span>
<span class="nc" id="L134">        return ResponseEntity.ok().build();</span>
    }

    @Operation(summary = &quot;get profiles of all public channels&quot;)
    @AuthenticatedApi
    @SecurityRequirement(name = &quot;jwt&quot;)
    @ApiResponses(value = {
            @ApiResponse(
                    responseCode = &quot;200&quot;, description = &quot;profiles of channel&quot;,
                    content = @Content(mediaType = &quot;application/json&quot;,
                            schema = @Schema(implementation = PageOfChannel.class))),
    })
    @RequestMapping(path = &quot;/list&quot;, method = RequestMethod.GET)
    public ResponseEntity&lt;Object&gt; list(@ParameterObject @Valid PageRequest request) {
<span class="nc" id="L148">        PageList&lt;PublicChannelProfile&gt; pageList = channelService.getAllChannels(request);</span>
<span class="nc" id="L149">        return ResponseEntity.ok(new PageOfChannel(pageList));</span>
    }

    @Operation(summary = &quot;get profile of public channel&quot;)
    @AuthenticatedApi
    @SecurityRequirement(name = &quot;jwt&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;target channel is not exist&quot;,
                    content = @Content(mediaType = &quot;application/json&quot;,
                            schema = @Schema(implementation = ErrorMessageResponse.class))),
            @ApiResponse(
                    responseCode = &quot;200&quot;, description = &quot;profile of channel&quot;,
                    content = @Content(mediaType = &quot;application/json&quot;,
                            schema = @Schema(implementation = PublicChannelProfile.class))),
    })
    @RequestMapping(path = &quot;/profile&quot;, method = RequestMethod.GET)
    public ResponseEntity&lt;Object&gt; profile(@ParameterObject @Valid GetChannelProfileRequest request) {
        try {
<span class="nc" id="L167">            PublicChannelProfile profile = channelService.getChannelProfile(request.getChannelId());</span>
<span class="nc" id="L168">            return ResponseEntity.ok(profile);</span>
<span class="nc" id="L169">        } catch (ChannelDoesNotExist e) {</span>
<span class="nc" id="L170">            return new ResponseEntity&lt;&gt;(new ErrorMessageResponse(e.getMessage()), HttpStatus.NOT_FOUND);</span>
        }
    }

    @Operation(summary = &quot;subscribe to public channel&quot;)
    @AuthenticatedApi
    @SecurityRequirement(name = &quot;jwt-in-query&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;target channel is not exist&quot;,
                    content = @Content(mediaType = &quot;application/json&quot;,
                            schema = @Schema(implementation = ErrorMessageResponse.class))),
            @ApiResponse(
                    responseCode = &quot;200&quot;, description = &quot;subscribe to public channel via SSE, &quot; +
                    &quot;you will receive messages in data event like below&quot;,
                    content = @Content(mediaType = &quot;application/json&quot;,
                            array = @ArraySchema(schema = @Schema(implementation = PublicMessageDto.class)))),
    })
    @RequestMapping(path = &quot;/subscribe&quot;, method = RequestMethod.GET)
    public Object subscribe(@ParameterObject @Valid SubscribePublicChannelRequest request) {
        try {
<span class="nc" id="L190">            return channelService.subscribe(request.getChannelId());</span>
<span class="nc" id="L191">        } catch (ChannelDoesNotExist e) {</span>
<span class="nc" id="L192">            return new ResponseEntity&lt;&gt;(new ErrorMessageResponse(e.getMessage()), HttpStatus.NOT_FOUND);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>